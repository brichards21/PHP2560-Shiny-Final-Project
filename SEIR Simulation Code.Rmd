---
title: "PHP2560 SEIR Project"
author: "Breanna Richards, Tim Hedspeth, Nancy Liu"
date: "11/26/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(latex2exp)
```

Our Model:

- Some exposed individuals will enter the quarantined class and others enter the infectives.

- Individuals in quarantined and infected classes will enter diagnosed class

- Note that not all infected people will be diagnosed

- They will either enter the recovered class or die

- $\epsilon$ rate of exposed people moving into infective class

- $\lambda$ rate of exposed people moving into quarantined class

- $\sigma$ rate of quarantined people moving into diagnosed class

- $\theta$ rate of infectives moving into diagnosed class

- $\gamma$ rate of diagnosed moving into recovered class

- $\delta$ rate of infected and diagnosed people dying

- $\beta(t)$ transmission rate



Default Rate Values:

- $\epsilon = (1/3)(2/5)$

- $\lambda = (1/3)(3/5)$

- $\delta = (15/100)(1/21)$

- $\theta = 1/3$

- $\sigma = 1/3$

- $\gamma = 1/21$

- $k = 0.1$

Infection rate $\beta(t)$ is most important parameter because the model is most sensitive to it. 

Default Initial Number of People: 
- Exposed: E(0) = 477
- Infectives: I(0) = 286
- Quarantined: Q(0) = 191
- Diagnosed: J(0) = 848
- Recovered: R(0) = 1213


This is an example of our simulations and the plots!  

## Starting the Simulation


```{r}

# max_e = NULL,
# max_i = NULL, 
# max_q = NULL, 
# max_j = NULL

get_diagnosed <- function(e = 477, i = 286, q = 191, 
                j = 848, r = 1213, epsilon = (1/3)*(2/5),
lambda = (1/3)*(3/5), delta = (15/100)*(1/21), 
theta = 1/3, sigma = 1/3, gamma = 1/21, k = 0.1, b = (31 + t)/(22 + 5*t)) {
  
#' get_diagnosed

days <- 400


for (t in 1:(days - 1)) {


e[t+1] <- e[t] + b*((k*e[t])+i[t]) - (epsilon+lambda)*e[t]
i[t+1] <- i[t] + epsilon*e[t] - (delta + theta)*i[t]
q[t+1] <- q[t] + lambda*e[t] - sigma*q[t]
j[t+1] <- j[t] + theta*i[t] + sigma*q[t] - (delta + gamma)*j[t]
r[t+1] <- r[t] + gamma*j[t]


if (b == (31 + t)/(22 + 5*t)) {
  
  b <- (31 + (t+1))/(22 + 5*(t+1))
  
}



}

all_data <- as.data.frame(cbind(Time = 1:days, Exposed = e, Infectives = i, 
                                Quarantined = q, Diagnosed = j, Recovered = r))


index <- seq(1, days, 2)

all_data <- all_data[index, ] 

rownames(all_data) <- 1:nrow(all_data)

all_data <- all_data %>%
pivot_longer(!Time, names_to = "people_type", values_to = "num_people")

return(all_data)
}


example_data <- get_diagnosed()

```

This is a preview of what our data looks like! Users will be able to pick what columns they want to look at. 

```{r}

head(example_data)

```


## Visualization Examples (RESULTS)

```{r}



```


A checkbox will indicate which lines we want to see!

```{r}

# plot separately
ggplot(df_full[df_full$people_type == "Diagnosed", ], aes(x = Time,
                              y = num_people)) + geom_line() 


ggplot(df[df$people_type == "Exposed", ], aes(x = Time, 
                            y = num_people)) + geom_line() +
  labs(title = TeX("Number of Exposed Cases with $\\beta = 0.6781$"))

ggplot(df[df$people_type == "Infectives", ], aes(x = Time, 
                          y = num_people)) + geom_line() +
  labs(title = TeX("Number of Infected with $\\beta = 0.6781$"))

ggplot(df[df$people_type == "Quarantined", ], aes(x = Time, 
                            y = num_people)) + geom_line() +
  labs(title = TeX("Number of Quarantined Cases with $\\beta = 0.6781$"))

ggplot(df[df$people_type == "Recovered", ], aes(x = Time, 
                            y = num_people)) + geom_line() +
  labs(title = TeX("Number of Recovered Cases with $\\beta = 0.6781$"))


ggplot(df[df$people_type ==  "Diagnosed" | df$people_type == "Recovered", ],
       aes(x = Time, y = num_people)) + geom_line(aes(col = people_type)) +
  labs(title = TeX("Number of Diagnosed and Recovered Cases with $\\beta(t)$"))

ggplot(df, aes(x = Time, y = num_people)) + geom_line(aes(col = people_type)) +
  labs(title = TeX("Number of Cases by People Type with $\\beta(t)$"))


```


# Animate

```{r}

library(plotly)
library(gganimate)

df_b <- accumulate_by(df_full, ~ Time) 

times_b <- length(grep(max_data$names, df_b$people_type))

df_b <- df_b %>%
  mutate(max_num = rep(max_data$max_p, times_b))
rownames(df_b) <- df_b$max_num

ggplot(df_b) + geom_line(aes(x = Time, y = num_people, color = people_type)) + theme_minimal()+
  theme(legend.title = element_blank()) 

plot_max <- function(df_b) {
  while (j < length(max_data$names))
  p + geom_vline(xintercept = )
  
}
```


```{r}
wide_df_full <- df_full %>%
  pivot_wider(names_from = "people_type", values_from = "num_people")

max_data <- data.frame(max_p = apply(wide_df_full[, -1], 2, max)) 

max_data$names <- rownames(max_data) 

  

apply(df_full, 2, max)
```


```{r}
# button that says run the simulation
df_full %>%
  group_by(people_type) %>%
  summarize(Time = Time, max(num_people))

df_full %>%
  filter(num_people %in% max_data$max_p)

# function to run visual 
df_full %>%
  mutate(max_num = rep(max_data$max_p, nrow(df_full)/length(max_data$names)) )
```

```{r}

run_animation <- function(df_use) {

wide_dat <- df_use %>%
  pivot_wider(names_from = "people_type", values_from = "num_people")

max_data <- data.frame(max_p = apply(wide_dat[, -1], 2, max)) 

max_data$names <- rownames(max_data)


df_use <- accumulate_by(df_use, ~ Time) 



 times <- length(grep(max_data$names, df_use$people_type))
 
 df_use <- df_use %>%
  mutate(max_num = rep(max_data$max_p, times))
 
 df_use_check <- df_use %>%
 filter(num_people %in% max_data$max_p)

 
 max_data$max_time <- unique(df_use_check$Time)
 
  p <- ggplot(df_use, aes(frame = frame)) +
   geom_line(aes(x = Time, y = num_people, color = people_type)) +
   theme_minimal() +
   theme(legend.title = element_blank())
 
 p
 
  j <- 1
#  
#  while(j <= nrow(max_data)){
#    
#    p <- p + geom_segment(x = max_data$max_time[j] , y = 0, 
#                          xend = max_data$max_time[j], yend = max_data$max_p[j], linetype = "dashed",
#                          col = "red")
# 
#    j <- j + 1
# 
#  }
# 
# 
# 
# fig <- ggplotly(p)
# 
# fig %>%
#   layout (
#     xaxis = list(
#       title = "Day",
#      # range = c()
#       zeroline = F
#     ),
#     yaxis = list(
#       title = "Number of People",
#       zeroline = F
#     ) %>%
#   animation_opts(
#     frame = 100,
#     transition = 0,
#     redraw = T
#    )
#   )
# 
# fig

#%>%

#%>%
  # add_markers(ids = ~ num_people) %>%
  # layout (
  #   xaxis = list(
  #     title = "Day",
  #    # range = c()
  #     zeroline = F
  #   ),
  #   yaxis = list(
  #     title = "Number of People",
  #     zeroline = F
  #   )
  # ) %>%
  # animation_opts(
  #   frame = 100,
  #   transition = 0,
  #   redraw = T
  # ) %>%
  # animation_slider(
  #   hide = F
  # ) %>%
  # animation_button(
  #   x = 1, xanchor = "right", y = 0, yanchor = "bottom"
  # )


# df_use %>%
#   plot_ly(
#     x = ~ Time,
#     y = ~ num_people,
#     split = ~ people_type,
#     frame = ~ frame,
#     #type = 'scatter',
#     text = ~ round(num_people),
#     mode = 'lines',
#     hoverinfo = "text",
#     line = list(simplyfy = F)
#   ) %>%
#   add_markers(ids = ~ num_people) %>%
#   layout (
#     xaxis = list(
#       title = "Day",
#      # range = c()
#       zeroline = F
#     ),
#     yaxis = list(
#       title = "Number of People",
#       zeroline = F
#     )
#   ) %>%
#   animation_opts(
#     frame = 100,
#     transition = 0,
#     redraw = T
#   ) %>%
#   animation_slider(
#     hide = F
#   ) %>%
#   animation_button(
#     x = 1, xanchor = "right", y = 0, yanchor = "bottom"
#   )

}


run_animation(df_full)

```


 
 
 
 
```{r} 

 # unused code
# p +
#   
#   gganimate::transition_reveal(Time) +
#   
#   labs(title = "{frame_along}: Number of Diagnosed Cases with beta(t)",
#        caption = "diagnosed over time")


# p <- ggplot(df[df$people_type == "Diagnosed", ], aes(x = Time,
#                               y = num_people)) + geom_line() +
#   labs(title = TeX("Number of Diagnosed Cases with beta(t)")) +
#   theme_bw()
# 
# q <- ggplot(df, aes(x = Time, y = num_people)) + geom_line(aes(col = people_type)) +
#   labs(title = "Number of Cases by People Type with beta(t)")
# 
# 
# fig <- ggplotly(p, tooltip = "text")
# fig
# 
# fig <- fig %>%
#   animation_slider(
#     currentvalue = list(prefix = "Day ", font = list(color="red")))

```

https://www.datanovia.com/en/blog/gganimate-how-to-create-plots-with-beautiful-animation-in-r/




```{r}

library(plotly)
library(ggplot2)

df <- diamonds[sample(1:nrow(diamonds), size = 1000),]

p <- ggplot(df, aes(carat, price)) +
      geom_point() +
      theme(axis.ticks = element_line(size = 10))

ggplotly(p)
  

```

